---
phase: 03-tts-audio-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/src/main/java/com/vocab/bulgarian/audio/exception/AudioGenerationException.java
  - backend/src/main/java/com/vocab/bulgarian/audio/util/ContentHashUtil.java
  - backend/src/main/java/com/vocab/bulgarian/audio/config/AudioStorageConfig.java
  - backend/src/main/java/com/vocab/bulgarian/audio/config/AudioAsyncConfig.java
  - backend/src/main/resources/application.yml
  - backend/src/main/resources/application-dev.yml
autonomous: true

must_haves:
  truths:
    - "Audio storage directory is created on application startup if it does not exist"
    - "Content hash produces deterministic SHA-256 hex string for identical Bulgarian text input"
    - "Audio task executor thread pool is configured separately from LLM executor"
    - "Audio storage path and TTS voice are externalized in application properties"
  artifacts:
    - path: "backend/src/main/java/com/vocab/bulgarian/audio/exception/AudioGenerationException.java"
      provides: "Custom runtime exception for TTS failures"
      contains: "class AudioGenerationException"
    - path: "backend/src/main/java/com/vocab/bulgarian/audio/util/ContentHashUtil.java"
      provides: "SHA-256 content hash generation"
      contains: "MessageDigest"
    - path: "backend/src/main/java/com/vocab/bulgarian/audio/config/AudioStorageConfig.java"
      provides: "Storage directory initialization and path bean"
      contains: "@PostConstruct"
    - path: "backend/src/main/java/com/vocab/bulgarian/audio/config/AudioAsyncConfig.java"
      provides: "Dedicated thread pool for audio generation"
      contains: "audioTaskExecutor"
  key_links:
    - from: "backend/src/main/java/com/vocab/bulgarian/audio/config/AudioStorageConfig.java"
      to: "application.yml"
      via: "@Value injection"
      pattern: "audio\\.storage\\.path"
    - from: "backend/src/main/java/com/vocab/bulgarian/audio/config/AudioAsyncConfig.java"
      to: "Spring async infrastructure"
      via: "ThreadPoolTaskExecutor bean"
      pattern: "audioTaskExecutor"
---

<objective>
Audio generation infrastructure: exception handling, content hashing utility, storage configuration, and dedicated thread pool for TTS operations.

Purpose: Establish the foundation classes that the TTS service and audio controller will depend on. This separates configuration concerns from business logic.
Output: Four Java classes (exception, utility, two configs) and updated application properties with audio/TTS settings.
</objective>

<execution_context>
@/Users/kevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-tts-audio-generation/03-RESEARCH.md
@backend/src/main/java/com/vocab/bulgarian/llm/config/AsyncConfig.java
@backend/src/main/resources/application.yml
@backend/src/main/resources/application-dev.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create audio exception and content hash utility</name>
  <files>
    backend/src/main/java/com/vocab/bulgarian/audio/exception/AudioGenerationException.java
    backend/src/main/java/com/vocab/bulgarian/audio/util/ContentHashUtil.java
  </files>
  <action>
Create the `com.vocab.bulgarian.audio` package hierarchy with `exception` and `util` sub-packages.

**AudioGenerationException.java** in `audio/exception/`:
- Extends RuntimeException (unchecked, like LlmValidationException pattern from Phase 2)
- Constructors: (String message), (String message, Throwable cause)
- Package: `com.vocab.bulgarian.audio.exception`

**ContentHashUtil.java** in `audio/util/`:
- Static utility class (private constructor to prevent instantiation)
- `public static String generateHash(String text, String voiceName)` method:
  - Concatenates `text + "|" + voiceName` (pipe separator prevents collision between "aв" + "oice" and "aв|" + "oice")
  - Creates NEW MessageDigest.getInstance("SHA-256") as local variable (CRITICAL: not a class field -- MessageDigest is NOT thread-safe)
  - Digests using StandardCharsets.UTF_8
  - Returns lowercase hex string (64 chars for SHA-256)
- Private `bytesToHex(byte[] hash)` helper method
- Wraps NoSuchAlgorithmException in RuntimeException (SHA-256 always available in JDK)
- Package: `com.vocab.bulgarian.audio.util`

Follow existing project conventions: SLF4J Logger, Jakarta imports where applicable.
  </action>
  <verify>
Run `cd /Users/kevin/projects/bulgarian-vocabulary/backend && mvn compile -pl . -q` -- must compile without errors. Verify both files exist with correct package declarations.
  </verify>
  <done>
AudioGenerationException extends RuntimeException with two constructors. ContentHashUtil.generateHash("Здравей", "bg-BG-KalinaNeural") produces deterministic 64-char hex string. MessageDigest created as local variable (thread-safe).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create audio storage config, async config, and update application properties</name>
  <files>
    backend/src/main/java/com/vocab/bulgarian/audio/config/AudioStorageConfig.java
    backend/src/main/java/com/vocab/bulgarian/audio/config/AudioAsyncConfig.java
    backend/src/main/resources/application.yml
    backend/src/main/resources/application-dev.yml
  </files>
  <action>
**AudioStorageConfig.java** in `audio/config/`:
- @Configuration class
- @Value("${audio.storage.path}") private String audioStoragePath
- @Value("${tts.bulgarian.voice.default}") private String defaultVoice
- @PostConstruct method `ensureStorageDirectory()`: creates directory (Files.createDirectories) if it does not exist, logs the path. Wraps IOException in RuntimeException to fail fast on startup if directory cannot be created.
- @Bean method `audioStoragePath()` returning the String path (so other components can inject it by bean name or @Value)
- Package: `com.vocab.bulgarian.audio.config`

**AudioAsyncConfig.java** in `audio/config/`:
- @Configuration class
- @Bean(name = "audioTaskExecutor") method returning ThreadPoolTaskExecutor
  - Core pool: 2 threads (audio generation is I/O-bound waiting on edge-tts process, fewer threads needed than LLM)
  - Max pool: 4 threads
  - Queue capacity: 50 (larger queue since audio gen is faster than LLM calls)
  - Thread name prefix: "audio-async-"
  - CallerRunsPolicy rejection handler (consistent with Phase 2 LLM executor pattern)
  - setWaitForTasksToCompleteOnShutdown(true), setAwaitTerminationSeconds(30)
  - Call initialize() on the executor
- Do NOT implement AsyncConfigurer (that is already done by AsyncConfig in the LLM package for the default executor). This bean is a named executor referenced by @Async("audioTaskExecutor").
- Package: `com.vocab.bulgarian.audio.config`

**application.yml** updates (append to existing):
Add at root level (not nested under spring):
```yaml
# Audio/TTS Configuration
audio:
  storage:
    path: ${AUDIO_STORAGE_PATH:./storage/audio}
  cleanup:
    max-age-days: 30

tts:
  bulgarian:
    voice:
      female: bg-BG-KalinaNeural
      male: bg-BG-BorislavNeural
      default: ${tts.bulgarian.voice.female}
```

**application-dev.yml** updates (append to existing):
Add audio storage path pointing to external SSD:
```yaml
# Audio storage on external SSD (Mac Studio)
audio:
  storage:
    path: ${AUDIO_STORAGE_PATH:/Volumes/T7-NorthStar/bulgarian-vocab/audio}
```

Keep all existing content in both yml files intact. Only append new sections.
  </action>
  <verify>
Run `cd /Users/kevin/projects/bulgarian-vocabulary/backend && mvn compile -pl . -q` -- must compile without errors. Verify both config files exist. Verify application.yml contains `audio.storage.path` and `tts.bulgarian.voice.default` properties. Verify application-dev.yml contains external SSD path.
  </verify>
  <done>
AudioStorageConfig creates storage directory on startup via @PostConstruct. AudioAsyncConfig provides "audioTaskExecutor" bean with 2-4 threads. application.yml has audio.storage.path defaulting to ./storage/audio. application-dev.yml overrides to /Volumes/T7-NorthStar/bulgarian-vocab/audio. TTS voice config available via properties.
  </done>
</task>

</tasks>

<verification>
1. `mvn compile -q` passes with no errors
2. All 6 files exist at specified paths
3. ContentHashUtil produces 64-char hex strings
4. AudioStorageConfig has @PostConstruct method
5. AudioAsyncConfig has audioTaskExecutor bean
6. application.yml has audio.storage.path and tts.bulgarian.voice properties
7. application-dev.yml overrides audio storage path to external SSD
</verification>

<success_criteria>
- Audio infrastructure package (`com.vocab.bulgarian.audio`) established with config, exception, and util sub-packages
- Dedicated audio thread pool configured separately from LLM thread pool
- Audio storage path externalized and configurable per environment
- Content hash utility is thread-safe (local MessageDigest instance)
- Application compiles successfully
</success_criteria>

<output>
After completion, create `.planning/phases/03-tts-audio-generation/03-01-SUMMARY.md`
</output>
