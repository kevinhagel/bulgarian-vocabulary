---
phase: 04-core-vocabulary-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/pom.xml
  - backend/src/main/java/com/vocab/bulgarian/api/dto/OnCreate.java
  - backend/src/main/java/com/vocab/bulgarian/api/dto/OnUpdate.java
  - backend/src/main/java/com/vocab/bulgarian/api/dto/CreateLemmaRequestDTO.java
  - backend/src/main/java/com/vocab/bulgarian/api/dto/UpdateLemmaRequestDTO.java
  - backend/src/main/java/com/vocab/bulgarian/api/dto/InflectionUpdateDTO.java
  - backend/src/main/java/com/vocab/bulgarian/api/dto/LemmaResponseDTO.java
  - backend/src/main/java/com/vocab/bulgarian/api/dto/LemmaDetailDTO.java
  - backend/src/main/java/com/vocab/bulgarian/api/dto/InflectionDTO.java
  - backend/src/main/java/com/vocab/bulgarian/api/exception/GlobalExceptionHandler.java
  - backend/src/main/java/com/vocab/bulgarian/repository/LemmaRepository.java
autonomous: true

must_haves:
  truths:
    - "API request/response contracts are defined as Java Records with validation"
    - "MapStruct is available as compile-time annotation processor"
    - "Repository supports paginated browse, multi-field filtering, and PGroonga search"
    - "REST errors return consistent RFC 7807 ProblemDetail responses"
  artifacts:
    - path: "backend/pom.xml"
      provides: "MapStruct dependency and annotation processor"
      contains: "mapstruct"
    - path: "backend/src/main/java/com/vocab/bulgarian/api/dto/CreateLemmaRequestDTO.java"
      provides: "Create request with wordForm, translation, notes"
      contains: "record CreateLemmaRequestDTO"
    - path: "backend/src/main/java/com/vocab/bulgarian/api/dto/LemmaResponseDTO.java"
      provides: "List-level response with inflectionCount"
      contains: "record LemmaResponseDTO"
    - path: "backend/src/main/java/com/vocab/bulgarian/api/dto/LemmaDetailDTO.java"
      provides: "Detail response with inflections list"
      contains: "record LemmaDetailDTO"
    - path: "backend/src/main/java/com/vocab/bulgarian/api/exception/GlobalExceptionHandler.java"
      provides: "Centralized error handling"
      contains: "@RestControllerAdvice"
    - path: "backend/src/main/java/com/vocab/bulgarian/repository/LemmaRepository.java"
      provides: "Paginated and filtered queries"
      contains: "Pageable"
  key_links:
    - from: "api/dto/CreateLemmaRequestDTO.java"
      to: "api/dto/OnCreate.java"
      via: "validation group annotation"
      pattern: "OnCreate\\.class"
    - from: "api/exception/GlobalExceptionHandler.java"
      to: "ProblemDetail"
      via: "RFC 7807 error responses"
      pattern: "ProblemDetail\\.forStatus"
---

<objective>
Establish the DTO layer, MapStruct build dependency, global exception handling, and enhanced repository queries for Phase 4 vocabulary CRUD.

Purpose: Create all the types, validation contracts, and data access patterns that the service and controller layers (Plan 02) will depend on. This separates type definitions from business logic for clean dependency flow.

Output: Request/response DTOs as Java Records, validation groups, MapStruct in pom.xml, GlobalExceptionHandler with ProblemDetail, and LemmaRepository with pagination/filtering support.
</objective>

<execution_context>
@/Users/kevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-core-vocabulary-management/04-RESEARCH.md
@backend/pom.xml
@backend/src/main/java/com/vocab/bulgarian/domain/Lemma.java
@backend/src/main/java/com/vocab/bulgarian/domain/Inflection.java
@backend/src/main/java/com/vocab/bulgarian/domain/enums/Source.java
@backend/src/main/java/com/vocab/bulgarian/domain/enums/PartOfSpeech.java
@backend/src/main/java/com/vocab/bulgarian/domain/enums/DifficultyLevel.java
@backend/src/main/java/com/vocab/bulgarian/domain/enums/ReviewStatus.java
@backend/src/main/java/com/vocab/bulgarian/repository/LemmaRepository.java
@backend/src/main/java/com/vocab/bulgarian/llm/dto/LlmProcessingResult.java
@backend/src/main/java/com/vocab/bulgarian/llm/dto/LemmaDetectionResponse.java
@backend/src/main/java/com/vocab/bulgarian/llm/dto/InflectionSet.java
@backend/src/main/java/com/vocab/bulgarian/llm/dto/LemmaMetadata.java
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MapStruct dependency and create all API DTOs with validation groups</name>
  <files>
    backend/pom.xml
    backend/src/main/java/com/vocab/bulgarian/api/dto/OnCreate.java
    backend/src/main/java/com/vocab/bulgarian/api/dto/OnUpdate.java
    backend/src/main/java/com/vocab/bulgarian/api/dto/CreateLemmaRequestDTO.java
    backend/src/main/java/com/vocab/bulgarian/api/dto/UpdateLemmaRequestDTO.java
    backend/src/main/java/com/vocab/bulgarian/api/dto/InflectionUpdateDTO.java
    backend/src/main/java/com/vocab/bulgarian/api/dto/LemmaResponseDTO.java
    backend/src/main/java/com/vocab/bulgarian/api/dto/LemmaDetailDTO.java
    backend/src/main/java/com/vocab/bulgarian/api/dto/InflectionDTO.java
  </files>
  <action>
    1. Add MapStruct to pom.xml:
       - Add property: `<mapstruct.version>1.6.2</mapstruct.version>`
       - Add dependency: `org.mapstruct:mapstruct:${mapstruct.version}`
       - Add `maven-compiler-plugin` configuration with annotationProcessorPaths for `org.mapstruct:mapstruct-processor:${mapstruct.version}`. The project already has a `<build><plugins>` section with spring-boot-maven-plugin and flyway-maven-plugin, so add the maven-compiler-plugin as a sibling.

    2. Create validation group marker interfaces in `com.vocab.bulgarian.api.dto`:
       - `OnCreate.java`: empty interface `public interface OnCreate {}`
       - `OnUpdate.java`: empty interface `public interface OnUpdate {}`

    3. Create request DTOs:
       - `CreateLemmaRequestDTO.java`: Java Record with fields:
         - `@NotBlank(groups = OnCreate.class) @Size(min = 1, max = 100) String wordForm` (user-entered Bulgarian word, any form including multi-word)
         - `@NotBlank(groups = OnCreate.class) @Size(min = 1, max = 200) String translation` (English translation, required)
         - `@Size(max = 5000) String notes` (optional)
       - `UpdateLemmaRequestDTO.java`: Java Record with fields:
         - `@NotBlank(groups = OnUpdate.class) @Size(min = 1, max = 100) String text` (canonical lemma text)
         - `@NotBlank(groups = OnUpdate.class) @Size(min = 1, max = 200) String translation`
         - `@Size(max = 5000) String notes`
         - `List<InflectionUpdateDTO> inflections` (nullable - only if updating inflections)
       - `InflectionUpdateDTO.java`: Java Record with fields:
         - `Long id` (null for new inflections, present for existing)
         - `@NotBlank @Size(min = 1, max = 100) String form`
         - `@Size(max = 100) String grammaticalInfo`

    4. Create response DTOs:
       - `LemmaResponseDTO.java`: Java Record (list/summary view) with fields:
         - `Long id, String text, String translation, PartOfSpeech partOfSpeech, String category, DifficultyLevel difficultyLevel, Source source, ReviewStatus reviewStatus, int inflectionCount, LocalDateTime createdAt`
       - `LemmaDetailDTO.java`: Java Record (detail view with inflections) with fields:
         - `Long id, String text, String translation, String notes, PartOfSpeech partOfSpeech, String category, DifficultyLevel difficultyLevel, Source source, ReviewStatus reviewStatus, List<InflectionDTO> inflections, LocalDateTime createdAt, LocalDateTime updatedAt`
       - `InflectionDTO.java`: Java Record with fields:
         - `Long id, String form, String grammaticalInfo`

    All DTOs use `jakarta.validation.constraints` imports (not javax). Import enums from `com.vocab.bulgarian.domain.enums.*`.
  </action>
  <verify>
    Run `cd /Users/kevin/projects/bulgarian-vocabulary/backend && mvn compile -q` -- must compile with no errors. Verify all 8 new files exist in `backend/src/main/java/com/vocab/bulgarian/api/dto/`.
  </verify>
  <done>
    MapStruct dependency added to pom.xml with annotation processor. All 6 DTO records and 2 validation group interfaces compile successfully. CreateLemmaRequestDTO accepts wordForm (supports multi-word input), UpdateLemmaRequestDTO accepts text (canonical lemma). Response DTOs expose enum fields (PartOfSpeech, DifficultyLevel, Source, ReviewStatus) without exposing entity internals.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create global exception handler and enhance LemmaRepository with pagination and filtering</name>
  <files>
    backend/src/main/java/com/vocab/bulgarian/api/exception/GlobalExceptionHandler.java
    backend/src/main/java/com/vocab/bulgarian/repository/LemmaRepository.java
  </files>
  <action>
    1. Create `GlobalExceptionHandler.java` in `com.vocab.bulgarian.api.exception`:
       - Annotate with `@RestControllerAdvice`
       - Handle `jakarta.persistence.EntityNotFoundException`:
         - Return 404 with ProblemDetail: title "Resource Not Found", detail from exception message
       - Handle `MethodArgumentNotValidException` (from `org.springframework.web.bind.MethodArgumentNotValidException`):
         - Extract field errors as list of "field: message" strings
         - Return 400 with ProblemDetail: title "Validation Failed", set property "errors" with the list
       - Handle `org.springframework.web.method.annotation.MethodArgumentTypeMismatchException`:
         - Return 400 with ProblemDetail: title "Invalid Parameter", detail "Invalid value for parameter: {name}"
       - Handle generic `Exception` as catch-all:
         - Log the exception at ERROR level
         - Return 500 with ProblemDetail: title "Internal Server Error", detail "An unexpected error occurred"
         - Do NOT expose exception details in response (security)

    2. Enhance `LemmaRepository.java` (MODIFY existing file, preserve all existing methods):
       - Add imports: `org.springframework.data.domain.Page`, `org.springframework.data.domain.Pageable`
       - Add paginated browse method: `Page<Lemma> findAll(Pageable pageable)` -- already inherited from JpaRepository, but add explicit filtered variants:
         - `Page<Lemma> findBySource(Source source, Pageable pageable)`
         - `Page<Lemma> findByPartOfSpeech(PartOfSpeech partOfSpeech, Pageable pageable)`
         - `Page<Lemma> findByDifficultyLevel(DifficultyLevel difficultyLevel, Pageable pageable)`
         - `Page<Lemma> findBySourceAndPartOfSpeech(Source source, PartOfSpeech partOfSpeech, Pageable pageable)`
         - `Page<Lemma> findBySourceAndDifficultyLevel(Source source, DifficultyLevel difficultyLevel, Pageable pageable)`
         - `Page<Lemma> findByPartOfSpeechAndDifficultyLevel(PartOfSpeech partOfSpeech, DifficultyLevel difficultyLevel, Pageable pageable)`
         - `Page<Lemma> findBySourceAndPartOfSpeechAndDifficultyLevel(Source source, PartOfSpeech partOfSpeech, DifficultyLevel difficultyLevel, Pageable pageable)`
       - Add JOIN FETCH paginated query (for list view that needs inflection count):
         - `@Query("SELECT DISTINCT l FROM Lemma l LEFT JOIN FETCH l.inflections WHERE l.id IN :ids")`
         - `List<Lemma> findByIdInWithInflections(@Param("ids") List<Long> ids)` -- used for batch-loading inflections after paginated query
       - Keep all existing methods intact (searchByText, findByIdWithInflections, findAllWithInflections, findBySourceWithInflections, etc.)
  </action>
  <verify>
    Run `cd /Users/kevin/projects/bulgarian-vocabulary/backend && mvn compile -q` -- must compile with no errors. Verify GlobalExceptionHandler.java exists and contains @RestControllerAdvice annotation. Verify LemmaRepository.java contains Pageable parameter methods.
  </verify>
  <done>
    GlobalExceptionHandler returns RFC 7807 ProblemDetail responses for EntityNotFoundException (404), validation errors (400), type mismatch (400), and catch-all (500). LemmaRepository supports paginated queries with optional filtering by source, partOfSpeech, and difficultyLevel individually and in combination. All existing repository methods preserved.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/kevin/projects/bulgarian-vocabulary/backend && mvn compile -q` passes with zero errors
2. All files exist under `backend/src/main/java/com/vocab/bulgarian/api/` (new package)
3. MapStruct appears in pom.xml dependencies AND annotationProcessorPaths
4. LemmaRepository has both old methods and new Pageable methods
5. GlobalExceptionHandler has @RestControllerAdvice annotation
</verification>

<success_criteria>
- MapStruct dependency compiles and annotation processor is configured
- 8 DTO/validation files exist in api/dto/ package
- GlobalExceptionHandler handles 4 exception types with ProblemDetail
- LemmaRepository supports paginated, filtered queries for browse/search
- Full project compiles cleanly with `mvn compile`
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-vocabulary-management/04-01-SUMMARY.md`
</output>
