---
phase: 01-foundation-and-data-model
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/main/java/com/vocab/bulgarian/domain/Lemma.java
  - src/main/java/com/vocab/bulgarian/domain/Inflection.java
  - src/main/java/com/vocab/bulgarian/domain/enums/Source.java
  - src/main/java/com/vocab/bulgarian/domain/enums/PartOfSpeech.java
  - src/main/java/com/vocab/bulgarian/domain/enums/DifficultyLevel.java
  - src/main/java/com/vocab/bulgarian/domain/enums/ReviewStatus.java
  - src/main/java/com/vocab/bulgarian/repository/LemmaRepository.java
  - src/main/java/com/vocab/bulgarian/repository/InflectionRepository.java
autonomous: true

must_haves:
  truths:
    - "Lemma entity maps correctly to lemmas table with all columns"
    - "Inflection entity maps correctly to inflections table with foreign key to lemmas"
    - "Lemma has lazy-loaded one-to-many relationship to Inflection with cascade ALL and orphan removal"
    - "Inflection has lazy-loaded many-to-one relationship back to Lemma (bidirectional)"
    - "Lemma entity enforces non-null text, translation, and source via JPA and Bean Validation annotations"
    - "LemmaRepository provides findByIdWithInflections using JOIN FETCH"
    - "LemmaRepository provides PGroonga full-text search via native query"
    - "Spring Boot application starts successfully with Flyway migrations and JPA validation"
  artifacts:
    - path: "src/main/java/com/vocab/bulgarian/domain/Lemma.java"
      provides: "Lemma JPA entity with bidirectional relationship, validation, timestamps"
      contains: "@Entity"
    - path: "src/main/java/com/vocab/bulgarian/domain/Inflection.java"
      provides: "Inflection JPA entity with ManyToOne to Lemma"
      contains: "@ManyToOne"
    - path: "src/main/java/com/vocab/bulgarian/domain/enums/Source.java"
      provides: "Source enum (USER_ENTERED, SYSTEM_SEED)"
      contains: "enum Source"
    - path: "src/main/java/com/vocab/bulgarian/domain/enums/PartOfSpeech.java"
      provides: "Part of speech enum for Bulgarian grammar"
      contains: "enum PartOfSpeech"
    - path: "src/main/java/com/vocab/bulgarian/domain/enums/DifficultyLevel.java"
      provides: "Difficulty level enum (BEGINNER, INTERMEDIATE, ADVANCED)"
      contains: "enum DifficultyLevel"
    - path: "src/main/java/com/vocab/bulgarian/domain/enums/ReviewStatus.java"
      provides: "Review status enum for LLM metadata review workflow"
      contains: "enum ReviewStatus"
    - path: "src/main/java/com/vocab/bulgarian/repository/LemmaRepository.java"
      provides: "Spring Data JPA repository with custom queries including PGroonga search"
      contains: "JpaRepository"
    - path: "src/main/java/com/vocab/bulgarian/repository/InflectionRepository.java"
      provides: "Spring Data JPA repository for inflections"
      contains: "JpaRepository"
  key_links:
    - from: "src/main/java/com/vocab/bulgarian/domain/Lemma.java"
      to: "src/main/java/com/vocab/bulgarian/domain/Inflection.java"
      via: "@OneToMany(mappedBy = 'lemma') bidirectional relationship"
      pattern: "mappedBy.*lemma"
    - from: "src/main/java/com/vocab/bulgarian/domain/Inflection.java"
      to: "src/main/java/com/vocab/bulgarian/domain/Lemma.java"
      via: "@ManyToOne with @JoinColumn(name = 'lemma_id')"
      pattern: "JoinColumn.*lemma_id"
    - from: "src/main/java/com/vocab/bulgarian/domain/Lemma.java"
      to: "src/main/resources/db/migration/V1__create_schema.sql"
      via: "@Table(name = 'lemmas') and @Column mappings must match SQL schema"
      pattern: "@Table.*lemmas"
    - from: "src/main/java/com/vocab/bulgarian/repository/LemmaRepository.java"
      to: "src/main/java/com/vocab/bulgarian/domain/Lemma.java"
      via: "JpaRepository<Lemma, Long> generic type binding"
      pattern: "JpaRepository.*Lemma.*Long"
---

<objective>
Create the JPA domain model (Lemma, Inflection entities with enums) and Spring Data JPA repositories with custom queries including PGroonga full-text search.

Purpose: Provide the Java domain model that maps to the PostgreSQL schema created in Plan 01, with proper bidirectional relationships, validation annotations, and repository query methods that later phases (services, controllers) will build upon.

Output: JPA entities with bidirectional lazy-loaded relationships, enum types for source/part-of-speech/difficulty/review-status, and repositories with derived queries, JOIN FETCH, and PGroonga native search query.
</objective>

<execution_context>
@/Users/kevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-data-model/01-RESEARCH.md
@.planning/phases/01-foundation-and-data-model/01-CONTEXT.md
@.planning/phases/01-foundation-and-data-model/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create enum types and JPA entities</name>
  <files>
    src/main/java/com/vocab/bulgarian/domain/enums/Source.java
    src/main/java/com/vocab/bulgarian/domain/enums/PartOfSpeech.java
    src/main/java/com/vocab/bulgarian/domain/enums/DifficultyLevel.java
    src/main/java/com/vocab/bulgarian/domain/enums/ReviewStatus.java
    src/main/java/com/vocab/bulgarian/domain/Lemma.java
    src/main/java/com/vocab/bulgarian/domain/Inflection.java
  </files>
  <action>
Create enum types and JPA entities per locked decisions: hybrid domain model with critical invariants in entities, JPA annotations + Jakarta Bean Validation for defense in depth, lazy loading for Lemma-Inflection relationship.

**Enums (all in com.vocab.bulgarian.domain.enums package):**

Source.java:
- Values: USER_ENTERED, SYSTEM_SEED

PartOfSpeech.java:
- Values: NOUN, VERB, ADJECTIVE, ADVERB, PRONOUN, PREPOSITION, CONJUNCTION, NUMERAL, INTERJECTION, PARTICLE, INTERROGATIVE
- Note: covers Bulgarian parts of speech including INTERROGATIVE for question words and PARTICLE for common Bulgarian particles

DifficultyLevel.java:
- Values: BEGINNER, INTERMEDIATE, ADVANCED

ReviewStatus.java:
- Values: PENDING, REVIEWED, NEEDS_CORRECTION

**Lemma.java entity (com.vocab.bulgarian.domain):**

```
@Entity
@Table(name = "lemmas")
```

Fields with both JPA @Column and Jakarta validation annotations:
- id: Long, @Id @GeneratedValue(strategy = IDENTITY)
- text: String, @NotNull @Size(min=1, max=100) @Column(nullable=false, length=100) -- Bulgarian lemma text
- translation: String, @NotNull @Size(min=1, max=200) @Column(nullable=false, length=200) -- English translation
- notes: String, @Column(columnDefinition="TEXT") -- nullable, user-editable
- partOfSpeech: PartOfSpeech, @Enumerated(STRING) @Column(name="part_of_speech", length=30) -- nullable (LLM fills later)
- category: String, @Column(length=50) -- nullable (LLM fills later)
- difficultyLevel: DifficultyLevel, @Enumerated(STRING) @Column(name="difficulty_level", length=20) -- nullable
- source: Source, @NotNull @Enumerated(STRING) @Column(nullable=false, length=20)
- reviewStatus: ReviewStatus, @NotNull @Enumerated(STRING) @Column(name="review_status", nullable=false, length=20) -- default PENDING
- createdAt: LocalDateTime, @Column(name="created_at", nullable=false, updatable=false)
- updatedAt: LocalDateTime, @Column(name="updated_at", nullable=false)

Relationship:
```java
@OneToMany(
    mappedBy = "lemma",
    fetch = FetchType.LAZY,
    cascade = CascadeType.ALL,
    orphanRemoval = true
)
private List<Inflection> inflections = new ArrayList<>();
```

Lifecycle callbacks:
- @PrePersist: set createdAt and updatedAt to now, set reviewStatus to PENDING if null
- @PreUpdate: set updatedAt to now

Helper methods to maintain bidirectional relationship:
- addInflection(Inflection): adds to list AND sets inflection.lemma = this
- removeInflection(Inflection): removes from list AND sets inflection.lemma = null

Generate proper equals/hashCode based on id (null-safe for new entities). Generate getters and setters for all fields.

**Inflection.java entity (com.vocab.bulgarian.domain):**

```
@Entity
@Table(name = "inflections")
```

Fields:
- id: Long, @Id @GeneratedValue(strategy = IDENTITY)
- form: String, @NotNull @Size(min=1, max=100) @Column(nullable=false, length=100) -- inflected form
- grammaticalInfo: String, @Column(name="grammatical_info", length=100) -- nullable, describes grammatical context
- lemma: Lemma, @ManyToOne(fetch=FetchType.LAZY) @JoinColumn(name="lemma_id", nullable=false)
- createdAt: LocalDateTime, @Column(name="created_at", nullable=false, updatable=false)

Lifecycle callback:
- @PrePersist: set createdAt to now

Generate proper equals/hashCode based on id (null-safe). Generate getters and setters.

IMPORTANT: Use jakarta.persistence.* imports (NOT javax.persistence.*) -- this is Spring Boot 3.x with Jakarta EE 9+.
IMPORTANT: Use jakarta.validation.constraints.* for validation annotations.
  </action>
  <verify>
Verify files exist: `ls src/main/java/com/vocab/bulgarian/domain/enums/*.java src/main/java/com/vocab/bulgarian/domain/Lemma.java src/main/java/com/vocab/bulgarian/domain/Inflection.java`
Verify Jakarta imports: `grep 'jakarta.persistence' src/main/java/com/vocab/bulgarian/domain/Lemma.java`
Verify bidirectional relationship: `grep 'mappedBy' src/main/java/com/vocab/bulgarian/domain/Lemma.java` and `grep '@ManyToOne' src/main/java/com/vocab/bulgarian/domain/Inflection.java`
Verify lazy loading: `grep 'FetchType.LAZY' src/main/java/com/vocab/bulgarian/domain/Lemma.java` and `grep 'FetchType.LAZY' src/main/java/com/vocab/bulgarian/domain/Inflection.java`
Verify helper methods: `grep 'addInflection' src/main/java/com/vocab/bulgarian/domain/Lemma.java`
Verify validation: `grep '@NotNull' src/main/java/com/vocab/bulgarian/domain/Lemma.java`
  </verify>
  <done>
Four enum types (Source, PartOfSpeech, DifficultyLevel, ReviewStatus) and two JPA entities (Lemma, Inflection) exist with bidirectional lazy-loaded relationship, CascadeType.ALL with orphanRemoval, helper methods for relationship maintenance, both JPA @Column and Jakarta @NotNull/@Size validation annotations, and @PrePersist/@PreUpdate lifecycle callbacks.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Spring Data JPA repositories with custom queries</name>
  <files>
    src/main/java/com/vocab/bulgarian/repository/LemmaRepository.java
    src/main/java/com/vocab/bulgarian/repository/InflectionRepository.java
  </files>
  <action>
Create Spring Data JPA repository interfaces.

**LemmaRepository.java (com.vocab.bulgarian.repository):**

Extends JpaRepository&lt;Lemma, Long&gt;

Derived query methods:
- `List<Lemma> findBySourceOrderByTextAsc(Source source)` -- find all lemmas by source type
- `List<Lemma> findByPartOfSpeechOrderByTextAsc(PartOfSpeech partOfSpeech)` -- find by part of speech
- `List<Lemma> findByDifficultyLevelOrderByTextAsc(DifficultyLevel difficultyLevel)` -- find by difficulty
- `boolean existsByTextAndSource(String text, Source source)` -- check for duplicates
- `Optional<Lemma> findByTextIgnoreCase(String text)` -- find by exact text (case-insensitive)
- `List<Lemma> findByReviewStatus(ReviewStatus reviewStatus)` -- find by review status

Custom JPQL queries:
- `findByIdWithInflections(Long id)` -- JOIN FETCH to solve N+1 problem:
  ```
  @Query("SELECT l FROM Lemma l LEFT JOIN FETCH l.inflections WHERE l.id = :id")
  Optional<Lemma> findByIdWithInflections(@Param("id") Long id);
  ```

- `findAllWithInflections()` -- fetch all lemmas with inflections eagerly:
  ```
  @Query("SELECT DISTINCT l FROM Lemma l LEFT JOIN FETCH l.inflections ORDER BY l.text ASC")
  List<Lemma> findAllWithInflections();
  ```

- `findBySourceWithInflections(Source source)` -- filtered fetch with inflections:
  ```
  @Query("SELECT DISTINCT l FROM Lemma l LEFT JOIN FETCH l.inflections WHERE l.source = :source ORDER BY l.text ASC")
  List<Lemma> findBySourceWithInflections(@Param("source") Source source);
  ```

PGroonga native search query:
- `searchByText(String searchQuery)` -- full-text search on lemma text:
  ```
  @Query(value = "SELECT * FROM lemmas WHERE text &@~ :searchQuery ORDER BY pgroonga_score(tableoid, ctid) DESC LIMIT 20", nativeQuery = true)
  List<Lemma> searchByText(@Param("searchQuery") String searchQuery);
  ```

**InflectionRepository.java (com.vocab.bulgarian.repository):**

Extends JpaRepository&lt;Inflection, Long&gt;

Derived query methods:
- `List<Inflection> findByLemmaId(Long lemmaId)` -- find all inflections for a lemma
- `List<Inflection> findByLemmaIdOrderByFormAsc(Long lemmaId)` -- sorted inflections
- `boolean existsByFormAndLemmaId(String form, Long lemmaId)` -- check for duplicate inflection

PGroonga native search query:
- `searchByForm(String searchQuery)` -- full-text search on inflection form:
  ```
  @Query(value = "SELECT * FROM inflections WHERE form &@~ :searchQuery LIMIT 20", nativeQuery = true)
  List<Inflection> searchByForm(@Param("searchQuery") String searchQuery);
  ```
  </action>
  <verify>
Verify files exist: `ls src/main/java/com/vocab/bulgarian/repository/LemmaRepository.java src/main/java/com/vocab/bulgarian/repository/InflectionRepository.java`
Verify JpaRepository extension: `grep 'JpaRepository' src/main/java/com/vocab/bulgarian/repository/LemmaRepository.java`
Verify JOIN FETCH: `grep 'JOIN FETCH' src/main/java/com/vocab/bulgarian/repository/LemmaRepository.java`
Verify PGroonga search: `grep 'pgroonga' src/main/java/com/vocab/bulgarian/repository/LemmaRepository.java`
Verify InflectionRepository: `grep 'JpaRepository' src/main/java/com/vocab/bulgarian/repository/InflectionRepository.java`
  </verify>
  <done>
LemmaRepository extends JpaRepository with derived query methods (findBySource, findByPartOfSpeech, existsByTextAndSource), JPQL queries with JOIN FETCH (findByIdWithInflections, findAllWithInflections), and PGroonga native search query (searchByText). InflectionRepository extends JpaRepository with derived queries and PGroonga form search.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify application startup with Flyway and JPA validation</name>
  <files></files>
  <action>
Start the Docker Compose PostgreSQL container and run the Spring Boot application to verify end-to-end:

1. Start PostgreSQL container: `docker compose up -d`
2. Wait for container health check to pass: `docker compose ps` shows healthy
3. Build and run the Spring Boot application: `./mvnw spring-boot:run` (or `mvn spring-boot:run`)
4. Verify in console output:
   - Flyway V1__create_schema.sql migrated successfully
   - Flyway V2__seed_reference_data.sql migrated successfully
   - Hibernate validates entities against schema without errors
   - Application starts on port 8080
5. Connect to PostgreSQL and verify data:
   - `docker exec -it bulgarian-vocab-db psql -U vocab_user -d bulgarian_vocab -c "SELECT COUNT(*) FROM lemmas WHERE source = 'SYSTEM_SEED';"`
   - Verify count matches expected number of seeded reference entries
   - `docker exec -it bulgarian-vocab-db psql -U vocab_user -d bulgarian_vocab -c "SELECT text, translation, source FROM lemmas LIMIT 10;"`
6. Stop the application (Ctrl+C)

If any errors occur:
- Flyway checksum error: migration file was modified -- check for typos, fix in migration
- JPA validation error: entity @Column doesn't match SQL column -- fix entity or migration to match
- Connection refused: Docker container not running -- restart with `docker compose up -d`
- PGroonga not found: Docker image doesn't include PGroonga -- verify using `groonga/pgroonga:latest` image
  </action>
  <verify>
Application starts without errors. Flyway reports 2 migrations applied. `SELECT COUNT(*) FROM lemmas WHERE source = 'SYSTEM_SEED'` returns expected count of seeded entries. No Hibernate validation errors in logs.
  </verify>
  <done>
Spring Boot application starts successfully, Flyway applies V1 (schema) and V2 (seed data), Hibernate validates JPA entities against schema without errors, and reference vocabulary exists in the database.
  </done>
</task>

</tasks>

<verification>
1. All four enum types exist with correct values
2. Lemma entity has: @Entity, @Table(name="lemmas"), bidirectional @OneToMany with LAZY/CASCADE ALL/orphanRemoval, @NotNull+@Column on required fields, @PrePersist/@PreUpdate callbacks, addInflection/removeInflection helper methods
3. Inflection entity has: @Entity, @Table(name="inflections"), @ManyToOne(LAZY) with @JoinColumn(name="lemma_id"), @NotNull+@Column on required fields
4. Entity column names match V1__create_schema.sql exactly (text, translation, notes, part_of_speech, category, difficulty_level, source, review_status, created_at, updated_at, form, grammatical_info, lemma_id)
5. LemmaRepository has JOIN FETCH queries and PGroonga native search query
6. Application starts, migrations run, entities validate against schema
7. Reference data queryable in database
</verification>

<success_criteria>
- `./mvnw compile` succeeds without errors (all entities and repositories compile)
- `./mvnw spring-boot:run` starts application with 2 Flyway migrations applied and no JPA validation errors
- PostgreSQL contains seeded reference vocabulary with correct source type
- All JPA entities use jakarta.persistence.* imports (not javax.persistence.*)
- Bidirectional relationship between Lemma and Inflection works with lazy loading
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-data-model/01-02-SUMMARY.md`
</output>
