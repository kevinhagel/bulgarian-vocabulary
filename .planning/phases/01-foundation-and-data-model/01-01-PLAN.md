---
phase: 01-foundation-and-data-model
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pom.xml
  - compose.yaml
  - src/main/java/com/vocab/bulgarian/BulgarianVocabularyApplication.java
  - src/main/resources/application.yml
  - src/main/resources/application-dev.yml
  - src/main/resources/db/migration/V1__create_schema.sql
  - src/main/resources/db/migration/V2__seed_reference_data.sql
  - .gitignore
autonomous: true

must_haves:
  truths:
    - "docker compose up starts PostgreSQL 16 with PGroonga extension available"
    - "Spring Boot application starts without errors and connects to PostgreSQL"
    - "Flyway runs V1 and V2 migrations automatically on startup"
    - "lemmas and inflections tables exist with correct columns and constraints"
    - "PGroonga index exists on lemmas.text for Cyrillic full-text search"
    - "Reference vocabulary (interrogatives, pronouns, prepositions, conjunctions, numerals) seeded in lemmas table"
    - "application-dev.yml contains Ollama base URL pointing to Mac Studio LAN IP"
  artifacts:
    - path: "pom.xml"
      provides: "Spring Boot project with JPA, PostgreSQL, Flyway, Validation dependencies"
      contains: "spring-boot-starter-data-jpa"
    - path: "compose.yaml"
      provides: "PostgreSQL with PGroonga Docker container"
      contains: "groonga/pgroonga"
    - path: "src/main/resources/application.yml"
      provides: "Database connection, JPA, Flyway configuration"
      contains: "spring.datasource"
    - path: "src/main/resources/application-dev.yml"
      provides: "Development profile with Ollama Mac Studio connectivity"
      contains: "ollama"
    - path: "src/main/resources/db/migration/V1__create_schema.sql"
      provides: "Database schema with lemmas, inflections tables and PGroonga index"
      contains: "CREATE TABLE lemmas"
    - path: "src/main/resources/db/migration/V2__seed_reference_data.sql"
      provides: "Reference vocabulary seed data"
      contains: "INSERT INTO lemmas"
    - path: "src/main/java/com/vocab/bulgarian/BulgarianVocabularyApplication.java"
      provides: "Spring Boot main application entry point"
      contains: "@SpringBootApplication"
  key_links:
    - from: "compose.yaml"
      to: "src/main/resources/application.yml"
      via: "PostgreSQL connection parameters (port, database, user, password)"
      pattern: "5432.*bulgarian_vocab"
    - from: "src/main/resources/application.yml"
      to: "src/main/resources/db/migration/"
      via: "Flyway migration location classpath:db/migration"
      pattern: "flyway.*locations.*classpath:db/migration"
---

<objective>
Bootstrap the Spring Boot project with Docker Compose PostgreSQL (PGroonga), Flyway migrations for schema and reference data, and development environment configuration.

Purpose: Establish the database foundation that all subsequent phases build upon -- the correct PostgreSQL schema for Bulgarian morphology with lemma/inflection separation, PGroonga search infrastructure, and seeded reference vocabulary.

Output: Runnable Spring Boot project that starts PostgreSQL via Docker Compose, creates the database schema via Flyway V1, seeds reference vocabulary via Flyway V2, and has development profiles for Ollama connectivity.
</objective>

<execution_context>
@/Users/kevin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/kevin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-data-model/01-RESEARCH.md
@.planning/phases/01-foundation-and-data-model/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Spring Boot project with Docker Compose and configuration</name>
  <files>
    pom.xml
    compose.yaml
    .gitignore
    src/main/java/com/vocab/bulgarian/BulgarianVocabularyApplication.java
    src/main/resources/application.yml
    src/main/resources/application-dev.yml
  </files>
  <action>
Create the Spring Boot project structure from scratch:

**pom.xml:**
- Parent: spring-boot-starter-parent 3.4.2 (or latest 3.4.x)
- Group: com.vocab
- Artifact: bulgarian-vocabulary
- Java version: 21 (stable LTS; Java 25 not yet released, use 21 which is the current LTS)
- Dependencies:
  - spring-boot-starter-data-jpa
  - spring-boot-starter-web (needed for eventual REST controllers)
  - spring-boot-starter-validation
  - postgresql (runtime)
  - flyway-core
  - flyway-database-postgresql
  - spring-boot-docker-compose (runtime, optional)
  - spring-boot-starter-test (test)
- Note: Do NOT add Spring AI dependencies yet (Phase 2)

**compose.yaml** (in project root, Spring Boot 3.1+ auto-detects):
- Service: postgres using `groonga/pgroonga:latest` image (PostgreSQL with PGroonga pre-installed)
- Container name: bulgarian-vocab-db
- Environment: POSTGRES_DB=bulgarian_vocab, POSTGRES_USER=vocab_user, POSTGRES_PASSWORD=vocab_pass
- Port: 5432:5432
- Volume: postgres-data for data persistence
- Healthcheck: pg_isready command

**BulgarianVocabularyApplication.java:**
- Package: com.vocab.bulgarian
- Standard @SpringBootApplication main class

**application.yml:**
- spring.application.name: bulgarian-vocabulary
- spring.datasource: PostgreSQL connection (localhost:5432/bulgarian_vocab, vocab_user/vocab_pass)
- spring.jpa.hibernate.ddl-auto: validate (Flyway handles schema, Hibernate only validates)
- spring.jpa.show-sql: false (enable per-profile)
- spring.jpa.properties.hibernate.dialect: org.hibernate.dialect.PostgreSQLDialect
- spring.jpa.properties.hibernate.jdbc.batch_size: 20
- spring.jpa.properties.hibernate.order_inserts: true
- spring.jpa.properties.hibernate.order_updates: true
- spring.flyway.enabled: true
- spring.flyway.locations: classpath:db/migration
- spring.flyway.baseline-on-migrate: true
- spring.docker.compose.enabled: true

**application-dev.yml** (development profile for MacBook M2):
- spring.jpa.show-sql: true
- spring.jpa.properties.hibernate.format_sql: true
- Ollama configuration placeholder: spring.ai.ollama.base-url: ${OLLAMA_BASE_URL:http://mac-studio.local:11434}
- Comment explaining this connects to Mac Studio Ollama over LAN

**.gitignore:**
- Standard Java/Maven ignores: target/, *.class, *.jar
- IDE ignores: .idea/, *.iml, .vscode/, .project, .classpath, .settings/
- OS: .DS_Store, Thumbs.db
- Environment: .env, *.env
  </action>
  <verify>
Run: `ls pom.xml compose.yaml src/main/java/com/vocab/bulgarian/BulgarianVocabularyApplication.java src/main/resources/application.yml src/main/resources/application-dev.yml .gitignore` -- all files exist.
Run: `grep 'spring-boot-starter-data-jpa' pom.xml` -- dependency present.
Run: `grep 'groonga/pgroonga' compose.yaml` -- PGroonga image used.
Run: `grep 'flyway' src/main/resources/application.yml` -- Flyway configured.
Run: `grep 'ollama' src/main/resources/application-dev.yml` -- Ollama URL configured.
  </verify>
  <done>
Spring Boot project structure exists with pom.xml (JPA, PostgreSQL, Flyway, Validation dependencies), compose.yaml (PGroonga PostgreSQL), application.yml (datasource, JPA validate mode, Flyway enabled), application-dev.yml (Ollama Mac Studio URL, SQL logging), and .gitignore.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Flyway migrations for schema and reference data</name>
  <files>
    src/main/resources/db/migration/V1__create_schema.sql
    src/main/resources/db/migration/V2__seed_reference_data.sql
  </files>
  <action>
Create two Flyway migration files following the locked decision: strict chronological versioning (V1, V2, V3...), forward-only, immutable after applied.

**V1__create_schema.sql:**

```sql
-- Enable PGroonga extension for Cyrillic full-text search
CREATE EXTENSION IF NOT EXISTS pgroonga;

CREATE TABLE lemmas (
    id BIGSERIAL PRIMARY KEY,
    text VARCHAR(100) NOT NULL,           -- Bulgarian lemma text (e.g., "говоря")
    translation VARCHAR(200) NOT NULL,    -- English translation
    notes TEXT,                           -- User-editable notes
    part_of_speech VARCHAR(30),           -- NOUN, VERB, ADJECTIVE, etc. (nullable: LLM fills in Phase 2)
    category VARCHAR(50),                 -- e.g., "food", "travel" (nullable: LLM fills in Phase 2)
    difficulty_level VARCHAR(20),         -- BEGINNER, INTERMEDIATE, ADVANCED (nullable: LLM fills in Phase 2)
    source VARCHAR(20) NOT NULL,          -- USER_ENTERED or SYSTEM_SEED
    review_status VARCHAR(20) NOT NULL DEFAULT 'PENDING',  -- PENDING, REVIEWED, NEEDS_CORRECTION
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE inflections (
    id BIGSERIAL PRIMARY KEY,
    lemma_id BIGINT NOT NULL REFERENCES lemmas(id) ON DELETE CASCADE,
    form VARCHAR(100) NOT NULL,           -- Inflected form (e.g., "говориш")
    grammatical_info VARCHAR(100),        -- e.g., "2nd person singular present indicative"
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP
);

-- PGroonga index for Bulgarian Cyrillic full-text search on lemma text
CREATE INDEX idx_lemmas_text_pgroonga ON lemmas USING pgroonga(text);

-- PGroonga index on inflection forms for searching inflected forms
CREATE INDEX idx_inflections_form_pgroonga ON inflections USING pgroonga(form);

-- Standard B-tree indexes for foreign keys and filtered queries
CREATE INDEX idx_inflections_lemma_id ON inflections(lemma_id);
CREATE INDEX idx_lemmas_source ON lemmas(source);
CREATE INDEX idx_lemmas_part_of_speech ON lemmas(part_of_speech);
CREATE INDEX idx_lemmas_difficulty_level ON lemmas(difficulty_level);
CREATE INDEX idx_lemmas_review_status ON lemmas(review_status);

-- Unique constraint: prevent duplicate lemma text per source
CREATE UNIQUE INDEX idx_lemmas_text_source ON lemmas(text, source);
```

Key design decisions in schema:
- part_of_speech, category, difficulty_level are nullable because LLM fills these in Phase 2 (user-entered lemmas won't have them initially)
- review_status tracks LLM metadata review workflow (PENDING = needs review, REVIEWED = confirmed, NEEDS_CORRECTION = flagged)
- ON DELETE CASCADE on inflections.lemma_id: deleting a lemma deletes its inflections (per user decision: "Delete vocabulary entries for corrections or re-entry")
- Unique constraint on (text, source) prevents duplicate lemmas within same source type but allows same text as both USER_ENTERED and SYSTEM_SEED

**V2__seed_reference_data.sql:**

Seed reference vocabulary per locked decision. Include:
- Interrogatives: кой (who), какво (what), кога (when), къде (where), защо (why), как (how), колко (how many/much), чий (whose)
- Personal pronouns: аз (I), ти (you informal), той (he), тя (she), то (it), ние (we), вие (you formal/plural), те (they)
- Prepositions: на (on/to), в/във (in), с/със (with), за (for), от (from), до (to/until), без (without), между (between), над (above), под (below), след (after), преди (before), при (at/by), около (around)
- Conjunctions: и (and), но (but), или (or), а (and/but), ако (if), защото (because), когато (when), че (that), макар че (although), докато (while)
- Numerals 1-10: едно (one), две (two), три (three), четири (four), пет (five), шест (six), седем (seven), осем (eight), девет (nine), десет (ten)

All seeded with source = 'SYSTEM_SEED' and review_status = 'REVIEWED' (reference data is pre-verified).
Mark the migration file with a comment: "IMMUTABLE: Never modify this file. Create new migration for updates (e.g., V5__update_pronouns.sql)."
  </action>
  <verify>
Verify file existence: `ls src/main/resources/db/migration/V1__create_schema.sql src/main/resources/db/migration/V2__seed_reference_data.sql`
Verify schema contents: `grep 'CREATE TABLE lemmas' src/main/resources/db/migration/V1__create_schema.sql`
Verify PGroonga: `grep 'pgroonga' src/main/resources/db/migration/V1__create_schema.sql`
Verify seed data: `grep 'SYSTEM_SEED' src/main/resources/db/migration/V2__seed_reference_data.sql`
Verify immutability comment: `grep 'IMMUTABLE' src/main/resources/db/migration/V2__seed_reference_data.sql`
  </verify>
  <done>
V1__create_schema.sql creates lemmas and inflections tables with PGroonga indexes, proper constraints, and nullable LLM-generated fields. V2__seed_reference_data.sql seeds interrogatives, pronouns, prepositions, conjunctions, and numerals 1-10 as SYSTEM_SEED reference vocabulary with REVIEWED status.
  </done>
</task>

</tasks>

<verification>
1. All files exist in expected directory structure
2. pom.xml has all required dependencies (JPA, PostgreSQL, Flyway, Validation, Docker Compose)
3. compose.yaml uses groonga/pgroonga image with correct PostgreSQL configuration
4. application.yml connects to correct database with Flyway enabled and JPA validate mode
5. application-dev.yml has Ollama Mac Studio URL placeholder
6. V1__create_schema.sql creates both tables with correct columns, PGroonga indexes, and constraints
7. V2__seed_reference_data.sql seeds all five reference vocabulary categories
8. Migration versioning follows strict V1, V2 convention (not V1.1 or similar)
</verification>

<success_criteria>
- Spring Boot project compiles: `./mvnw compile` succeeds (if Maven wrapper created) or `mvn compile` succeeds
- Docker Compose starts PostgreSQL: `docker compose up -d` starts the PGroonga-enabled PostgreSQL container
- All migration files follow naming convention V{N}__{description}.sql
- Schema includes PGroonga extension and indexes
- Seed data covers all five reference vocabulary categories (interrogatives, pronouns, prepositions, conjunctions, numerals)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-data-model/01-01-SUMMARY.md`
</output>
