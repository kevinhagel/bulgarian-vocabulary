---
phase: 06-flashcards-basic-study
plan: 04
type: execute
wave: 4
depends_on: [06-01, 06-02, 06-03]
files_modified:
  - backend/src/main/java/com/vocab/bulgarian/api/exception/GlobalExceptionHandler.java
  - backend/src/main/java/com/vocab/bulgarian/study/service/StudySessionService.java
  - frontend/src/features/vocabulary/components/VocabularyList.tsx
  - frontend/src/features/study/components/StudyLauncher.tsx
autonomous: true

must_haves:
  truths:
    - "POST /api/study/sessions with 0 available cards returns 400 with clear message"
    - "POST /api/study/sessions/{id}/rate on non-ACTIVE session returns 400"
    - "VocabularyList header shows orange due count badge when cards are due"
    - "Clicking due count badge navigates to Study tab"
    - "All 15 Phase 6 success criteria pass in end-to-end UAT"
    - "mvn compile -q passes"
    - "npx tsc --noEmit passes"
    - "npm run build succeeds"
---

<objective>
Harden Phase 6 with error handling, edge case coverage, and UX polish. Add due count badge on vocabulary list. Verify all 15 success criteria end-to-end.
</objective>

<tasks>

<task type="auto">
  <name>Task 1: Backend error handling for study service</name>
  <files>
    backend/src/main/java/com/vocab/bulgarian/api/exception/GlobalExceptionHandler.java
    backend/src/main/java/com/vocab/bulgarian/study/service/StudySessionService.java
  </files>
  <action>
    **Update GlobalExceptionHandler.java** — read the existing file first, then add handler:
    ```java
    @ExceptionHandler(IllegalStateException.class)
    public ResponseEntity<Map<String, String>> handleIllegalState(
        IllegalStateException ex, HttpServletRequest request
    ) {
        logger.warn("Illegal state: {}", ex.getMessage());
        return ResponseEntity.status(HttpStatus.BAD_REQUEST)
            .body(Map.of(
                "error", "Invalid session state",
                "message", ex.getMessage(),
                "path", request.getRequestURI()
            ));
    }
    ```
    Ensure imports: `HttpServletRequest`, `HttpStatus`, `Map` are present.

    **Verify StudySessionService.startSession** already throws `IllegalStateException` when sessionIds is empty.
    If not present, add before building the session:
    ```java
    if (sessionIds.isEmpty()) {
        throw new IllegalStateException(
            "No cards available for study. Add vocabulary or wait for scheduled review dates.");
    }
    ```
  </action>
  <verify>
    cd /Users/kevin/bulgarian-vocabulary/backend && mvn compile -q 2>&1 | tail -5
    curl -s -X POST "http://localhost:8080/api/study/sessions?maxCards=20"
    # If DB has 0 user-entered completed lemmas: {"error":"Invalid session state","message":"No cards available..."}
  </verify>
  <done>GlobalExceptionHandler handles IllegalStateException. Empty session guard in place. mvn compile passes.</done>
</task>

<task type="auto">
  <name>Task 2: Due count badge on VocabularyList + StudyLauncher empty state</name>
  <files>
    frontend/src/features/vocabulary/components/VocabularyList.tsx
    frontend/src/App.tsx
  </files>
  <action>
    **Update VocabularyList.tsx** — read existing file, then:
    1. Add `onNavigateStudy?: () => void` prop to the component's props interface
    2. Import `useDueCount` from `@/features/study/api/useDueCount`
    3. Add near the top of the component:
       ```typescript
       const { data: dueCount } = useDueCount();
       const totalDue = (dueCount?.dueToday ?? 0) + (dueCount?.newCards ?? 0);
       ```
    4. In the header/toolbar area alongside the existing "Add Vocabulary" button, add:
       ```tsx
       {totalDue > 0 && onNavigateStudy && (
         <button
           onClick={onNavigateStudy}
           className="flex items-center gap-1.5 px-3 py-2 bg-orange-50 hover:bg-orange-100
                      border border-orange-200 rounded-lg text-sm font-medium text-orange-700
                      transition-colors"
         >
           <span className="inline-flex items-center justify-center w-5 h-5 bg-orange-500
                            text-white text-xs rounded-full font-bold">
             {totalDue > 99 ? '99+' : totalDue}
           </span>
           Study
         </button>
       )}
       ```

    **Update App.tsx** — pass `onNavigateStudy` to VocabularyList:
    ```tsx
    <VocabularyList
      onViewDetail={setSelectedLemmaId}
      onNavigateStudy={() => setAppView('study')}
    />
    ```
  </action>
  <verify>
    cd /Users/kevin/bulgarian-vocabulary/frontend && npx tsc --noEmit 2>&1 | tail -10
    npm run build 2>&1 | tail -5
  </verify>
  <done>VocabularyList shows due count badge. App passes onNavigateStudy. TypeScript and build pass.</done>
</task>

<task type="auto">
  <name>Task 3: End-to-end UAT — verify all 15 Phase 6 success criteria</name>
  <files></files>
  <action>
    With backend and frontend running, verify each success criterion:

    **Prerequisites:**
    - At least 3 USER_ENTERED vocabulary entries with processingStatus=COMPLETED
    - `ollama ps` shows bggpt model loaded

    **Verify via browser + curl:**

    1. Start session → FlashcardView loads with Bulgarian text
    2. AudioPlayer on card front plays pronunciation
    3. Reveal → English translation visible
    4. Inflections table on card back (from FlashcardBack)
    5. Correct/Incorrect buttons work, card advances
    6. SessionProgress bar updates after each rating
    7. "End session early" works, shows summary
    8. After session: `curl http://localhost:8080/api/study/stats/{lemmaId}` shows intervalDays > 0
    9. VocabularyDetail for studied word shows next review date
    10. Study tab shows ProgressDashboard with all 4 tiles
    11. VocabularyDetail shows LemmaSrsInfo with reviewCount, correctRate, lastReviewedAt
    12. ProgressDashboard totalUserVocab = USER_ENTERED count only
    13. retentionRate = correctCount / cardsReviewed * 100 in both dashboard and summary

    **Database spot checks:**
    ```bash
    export PGPASSWORD='BG_Vocab_2026_PostgreSQL!'
    psql -h localhost -U vocab_user -d bulgarian_vocab \
      -c "SELECT l.text, s.interval_days, s.ease_factor, s.next_review_date, s.repetition_count
          FROM srs_state s JOIN lemmas l ON l.id = s.lemma_id
          ORDER BY s.updated_at DESC LIMIT 5;"

    psql -h localhost -U vocab_user -d bulgarian_vocab \
      -c "SELECT id, status, card_count, cards_reviewed, correct_count FROM study_sessions ORDER BY started_at DESC LIMIT 3;"
    ```

    **After CORRECT rating:** interval_days should increase (0→1→6→higher), repetition_count increments
    **After INCORRECT rating:** interval_days = 1, ease_factor decreases (min 1.30)
  </action>
  <verify>
    All 15 success criteria checked. srs_state rows show correct SM-2 updates. mvn compile, npx tsc, npm run build all pass.
  </verify>
  <done>All 15 Phase 6 success criteria verified end-to-end. Phase 6 complete.</done>
</task>

</tasks>

<verification>
1. mvn compile passes
2. npx tsc --noEmit passes
3. npm run build succeeds
4. POST /api/study/sessions with 0 cards returns 400
5. VocabularyList shows orange badge when cards due
6. All 15 ROADMAP success criteria verified
7. srs_state updates correctly in DB after each rating
</verification>

<success_criteria>
All 15 Phase 6 success criteria pass. Error handling prevents crashes. Phase 6 production-ready.
</success_criteria>

<output>
After completion:
1. Create `.planning/phases/06-flashcards-basic-study/06-04-SUMMARY.md`
2. Update ROADMAP.md Phase 6 status to Complete
3. Update STATE.md to Phase 7 ready
</output>
