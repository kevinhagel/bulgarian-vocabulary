---
phase: 06-flashcards-basic-study
plan: 03
type: execute
wave: 3
depends_on: [06-01, 06-02]
files_modified:
  - backend/src/main/java/com/vocab/bulgarian/study/dto/ProgressDashboardDTO.java
  - backend/src/main/java/com/vocab/bulgarian/study/dto/LemmaStatsDTO.java
  - backend/src/main/java/com/vocab/bulgarian/study/service/ProgressService.java
  - backend/src/main/java/com/vocab/bulgarian/study/controller/ProgressController.java
  - backend/src/main/java/com/vocab/bulgarian/repository/LemmaRepository.java
  - frontend/src/features/study/api/useProgress.ts
  - frontend/src/features/study/api/useLemmaStats.ts
  - frontend/src/features/study/components/ProgressDashboard.tsx
  - frontend/src/features/vocabulary/components/LemmaSrsInfo.tsx
  - frontend/src/features/vocabulary/components/VocabularyDetail.tsx
  - frontend/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "GET /api/study/progress returns ProgressDashboardDTO"
    - "GET /api/study/stats/{lemmaId} returns LemmaStatsDTO"
    - "ProgressDashboard renders 4 stat tiles: total vocab, total sessions, cards reviewed, retention rate"
    - "VocabularyDetail shows LemmaSrsInfo panel for USER_ENTERED lemmas"
    - "LemmaSrsInfo shows 'Not studied yet' when reviewCount = 0"
    - "mvn compile -q passes"
    - "npx tsc --noEmit passes"
    - "npm run build succeeds"
---

<objective>
Build the progress dashboard and per-lemma SRS statistics. Backend aggregation, REST endpoints, frontend dashboard, and the LemmaSrsInfo panel in VocabularyDetail.
</objective>

<tasks>

<task type="auto">
  <name>Task 1: Backend progress API — DTOs, ProgressService, ProgressController</name>
  <files>
    backend/src/main/java/com/vocab/bulgarian/study/dto/ProgressDashboardDTO.java
    backend/src/main/java/com/vocab/bulgarian/study/dto/LemmaStatsDTO.java
    backend/src/main/java/com/vocab/bulgarian/study/service/ProgressService.java
    backend/src/main/java/com/vocab/bulgarian/study/controller/ProgressController.java
    backend/src/main/java/com/vocab/bulgarian/repository/LemmaRepository.java
  </files>
  <action>
    **ProgressDashboardDTO.java**:
    ```java
    package com.vocab.bulgarian.study.dto;
    public record ProgressDashboardDTO(
        long totalUserVocab,
        long totalVocabStudied,
        long totalSessions,
        long totalCardsReviewed,
        long totalCorrect,
        int retentionRate,
        long cardsDueToday,
        long newCards
    ) {}
    ```

    **LemmaStatsDTO.java**:
    ```java
    package com.vocab.bulgarian.study.dto;
    import java.time.LocalDate;
    import java.time.ZonedDateTime;
    public record LemmaStatsDTO(
        Long lemmaId,
        long reviewCount,
        long correctCount,
        int correctRate,
        ZonedDateTime lastReviewedAt,
        LocalDate nextReviewDate,
        int intervalDays,
        double easeFactor
    ) {}
    ```

    **Add countBySource to LemmaRepository** — add this method:
    ```java
    long countBySource(com.vocab.bulgarian.domain.enums.Source source);
    ```

    **ProgressService.java**:
    ```java
    package com.vocab.bulgarian.study.service;

    import com.vocab.bulgarian.domain.enums.Source;
    import com.vocab.bulgarian.repository.LemmaRepository;
    import com.vocab.bulgarian.study.domain.enums.SessionStatus;
    import com.vocab.bulgarian.study.dto.LemmaStatsDTO;
    import com.vocab.bulgarian.study.dto.ProgressDashboardDTO;
    import com.vocab.bulgarian.study.repository.SrsStateRepository;
    import com.vocab.bulgarian.study.repository.StudySessionRepository;
    import com.vocab.bulgarian.study.repository.StudyReviewRepository;
    import jakarta.persistence.EntityNotFoundException;
    import org.springframework.stereotype.Service;
    import org.springframework.transaction.annotation.Transactional;
    import java.time.LocalDate;

    @Service
    @Transactional(readOnly = true)
    public class ProgressService {

        private final LemmaRepository lemmaRepository;
        private final SrsStateRepository srsStateRepository;
        private final StudySessionRepository sessionRepository;
        private final StudyReviewRepository reviewRepository;

        public ProgressService(
            LemmaRepository lemmaRepository,
            SrsStateRepository srsStateRepository,
            StudySessionRepository sessionRepository,
            StudyReviewRepository reviewRepository
        ) {
            this.lemmaRepository = lemmaRepository;
            this.srsStateRepository = srsStateRepository;
            this.sessionRepository = sessionRepository;
            this.reviewRepository = reviewRepository;
        }

        public ProgressDashboardDTO getDashboard() {
            long totalUserVocab = lemmaRepository.countBySource(Source.USER_ENTERED);
            long totalVocabStudied = srsStateRepository.count();
            long completedSessions = sessionRepository.countByStatus(SessionStatus.COMPLETED);
            long abandonedSessions = sessionRepository.countByStatus(SessionStatus.ABANDONED);
            long totalSessions = completedSessions + abandonedSessions;
            long totalCardsReviewed = sessionRepository.sumTotalCardsReviewed();
            long totalCorrect = sessionRepository.sumTotalCorrect();
            int retentionRate = totalCardsReviewed > 0
                ? (int) Math.round((double) totalCorrect / totalCardsReviewed * 100)
                : 0;
            long cardsDueToday = srsStateRepository.countDueCards(LocalDate.now());
            long newCards = srsStateRepository.findLemmaIdsWithoutSrsState().size();
            return new ProgressDashboardDTO(totalUserVocab, totalVocabStudied, totalSessions,
                totalCardsReviewed, totalCorrect, retentionRate, cardsDueToday, newCards);
        }

        public LemmaStatsDTO getLemmaStats(Long lemmaId) {
            if (!lemmaRepository.existsById(lemmaId)) {
                throw new EntityNotFoundException("Lemma not found: " + lemmaId);
            }
            long reviewCount = reviewRepository.countByLemmaId(lemmaId);
            long correctCount = reviewRepository.countCorrectByLemmaId(lemmaId);
            int correctRate = reviewCount > 0
                ? (int) Math.round((double) correctCount / reviewCount * 100)
                : 0;
            return srsStateRepository.findByLemmaId(lemmaId)
                .map(srs -> new LemmaStatsDTO(lemmaId, reviewCount, correctCount, correctRate,
                    srs.getLastReviewedAt(), srs.getNextReviewDate(),
                    srs.getIntervalDays(), srs.getEaseFactor().doubleValue()))
                .orElse(new LemmaStatsDTO(lemmaId, reviewCount, correctCount, correctRate,
                    null, null, 0, 0.0));
        }
    }
    ```

    **ProgressController.java**:
    ```java
    package com.vocab.bulgarian.study.controller;

    import com.vocab.bulgarian.study.dto.LemmaStatsDTO;
    import com.vocab.bulgarian.study.dto.ProgressDashboardDTO;
    import com.vocab.bulgarian.study.service.ProgressService;
    import org.springframework.http.ResponseEntity;
    import org.springframework.web.bind.annotation.*;

    @RestController
    @RequestMapping("/api/study")
    public class ProgressController {
        private final ProgressService progressService;
        public ProgressController(ProgressService progressService) { this.progressService = progressService; }

        @GetMapping("/progress")
        public ResponseEntity<ProgressDashboardDTO> getDashboard() {
            return ResponseEntity.ok(progressService.getDashboard());
        }

        @GetMapping("/stats/{lemmaId}")
        public ResponseEntity<LemmaStatsDTO> getLemmaStats(@PathVariable Long lemmaId) {
            return ResponseEntity.ok(progressService.getLemmaStats(lemmaId));
        }
    }
    ```
  </action>
  <verify>
    cd /Users/kevin/bulgarian-vocabulary/backend && mvn compile -q 2>&1 | tail -5
    curl -s http://localhost:8080/api/study/progress
  </verify>
  <done>ProgressService and ProgressController created. GET /api/study/progress and /api/study/stats/{id} work. mvn compile passes.</done>
</task>

<task type="auto">
  <name>Task 2: Frontend ProgressDashboard, LemmaSrsInfo, VocabularyDetail update</name>
  <files>
    frontend/src/features/study/api/useProgress.ts
    frontend/src/features/study/api/useLemmaStats.ts
    frontend/src/features/study/components/ProgressDashboard.tsx
    frontend/src/features/vocabulary/components/LemmaSrsInfo.tsx
    frontend/src/features/vocabulary/components/VocabularyDetail.tsx
    frontend/src/App.tsx
  </files>
  <action>
    **Create frontend/src/features/study/api/useProgress.ts**:
    ```typescript
    import { useQuery } from '@tanstack/react-query';
    import api from '@/lib/api';
    import type { ProgressDashboardDTO } from '@/features/study/types';
    export function useProgress() {
      return useQuery<ProgressDashboardDTO>({
        queryKey: ['study', 'progress'],
        queryFn: async () => (await api.get<ProgressDashboardDTO>('/study/progress')).data,
        staleTime: 30_000,
      });
    }
    ```

    **Create frontend/src/features/study/api/useLemmaStats.ts**:
    ```typescript
    import { useQuery } from '@tanstack/react-query';
    import api from '@/lib/api';
    import type { LemmaStatsDTO } from '@/features/study/types';
    export function useLemmaStats(lemmaId: number | null) {
      return useQuery<LemmaStatsDTO>({
        queryKey: ['study', 'stats', lemmaId],
        queryFn: async () => (await api.get<LemmaStatsDTO>(`/study/stats/${lemmaId}`)).data,
        enabled: lemmaId !== null,
        staleTime: 30_000,
      });
    }
    ```

    **Create frontend/src/features/study/components/ProgressDashboard.tsx**:
    ```tsx
    import { useProgress } from '@/features/study/api/useProgress';

    function StatTile({ value, label, colorClass }: { value: number | string; label: string; colorClass: string }) {
      return (
        <div className="bg-white rounded-lg shadow-sm p-4 text-center">
          <div className={`text-2xl font-bold ${colorClass}`}>{value}</div>
          <div className="text-xs text-gray-500 mt-1">{label}</div>
        </div>
      );
    }

    export function ProgressDashboard() {
      const { data } = useProgress();
      if (!data) return null;
      const studied = data.totalUserVocab > 0
        ? Math.round((data.totalVocabStudied / data.totalUserVocab) * 100)
        : 0;
      const retentionColor = data.retentionRate >= 80 ? 'text-green-600' :
        data.retentionRate >= 50 ? 'text-yellow-600' : 'text-red-500';
      return (
        <div className="max-w-md mx-auto mt-6">
          <h3 className="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-3 text-center">Your Progress</h3>
          <div className="grid grid-cols-2 gap-3 mb-4">
            <StatTile value={data.totalUserVocab} label="Total Vocabulary" colorClass="text-gray-800" />
            <StatTile value={data.totalSessions} label="Study Sessions" colorClass="text-blue-600" />
            <StatTile value={data.totalCardsReviewed} label="Cards Reviewed" colorClass="text-green-600" />
            <StatTile value={`${data.retentionRate}%`} label="Retention Rate" colorClass={retentionColor} />
          </div>
          {data.totalUserVocab > 0 && (
            <div className="bg-white rounded-lg p-4 shadow-sm">
              <div className="flex justify-between text-xs text-gray-500 mb-1">
                <span>{data.totalVocabStudied} words studied</span>
                <span>{data.totalUserVocab} total</span>
              </div>
              <div className="w-full bg-gray-200 rounded-full h-2">
                <div className="bg-blue-500 h-2 rounded-full transition-all" style={{ width: `${studied}%` }} />
              </div>
              <p className="text-xs text-gray-400 text-center mt-2">{studied}% studied at least once</p>
            </div>
          )}
        </div>
      );
    }
    ```

    **Create frontend/src/features/vocabulary/components/LemmaSrsInfo.tsx**:
    ```tsx
    import { useLemmaStats } from '@/features/study/api/useLemmaStats';

    export function LemmaSrsInfo({ lemmaId }: { lemmaId: number }) {
      const { data: stats, isLoading } = useLemmaStats(lemmaId);
      if (isLoading || !stats) return null;

      if (stats.reviewCount === 0) {
        return (
          <div className="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-100">
            <p className="text-sm text-blue-700 text-center">
              Not studied yet. Start a study session to track progress for this word.
            </p>
          </div>
        );
      }

      const formatNext = (d: string | null) => {
        if (!d) return 'Not scheduled';
        const date = new Date(d);
        const today = new Date(); today.setHours(0,0,0,0); date.setHours(0,0,0,0);
        const diff = Math.round((date.getTime() - today.getTime()) / 86_400_000);
        if (diff < 0) return 'Overdue';
        if (diff === 0) return 'Today';
        if (diff === 1) return 'Tomorrow';
        return `In ${diff} days`;
      };

      const formatLast = (d: string | null) =>
        d ? new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'Never';

      const rateColor = stats.correctRate >= 80 ? 'text-green-600' :
        stats.correctRate >= 50 ? 'text-yellow-600' : 'text-red-500';

      return (
        <div className="mt-6">
          <h3 className="text-sm font-semibold text-gray-600 mb-3">Study Statistics</h3>
          <div className="bg-gray-50 rounded-lg border border-gray-100 p-4">
            <div className="grid grid-cols-2 gap-4 text-sm">
              <div>
                <span className="text-xs text-gray-400 block mb-0.5">Total Reviews</span>
                <span className="font-semibold text-gray-800">{stats.reviewCount}</span>
              </div>
              <div>
                <span className="text-xs text-gray-400 block mb-0.5">Correct Rate</span>
                <span className={`font-semibold ${rateColor}`}>{stats.correctRate}%</span>
              </div>
              <div>
                <span className="text-xs text-gray-400 block mb-0.5">Last Reviewed</span>
                <span className="font-semibold text-gray-800">{formatLast(stats.lastReviewedAt)}</span>
              </div>
              <div>
                <span className="text-xs text-gray-400 block mb-0.5">Next Review</span>
                <span className={`font-semibold ${stats.nextReviewDate && new Date(stats.nextReviewDate) < new Date() ? 'text-orange-500' : 'text-gray-800'}`}>
                  {formatNext(stats.nextReviewDate)}
                </span>
              </div>
            </div>
            {stats.intervalDays > 0 && (
              <p className="text-xs text-gray-400 mt-3 pt-3 border-t border-gray-200">
                Interval: {stats.intervalDays}d | Ease: {stats.easeFactor.toFixed(2)}
              </p>
            )}
          </div>
        </div>
      );
    }
    ```

    **Update VocabularyDetail.tsx** — add import and render LemmaSrsInfo for USER_ENTERED lemmas:
    - Add: `import { LemmaSrsInfo } from './LemmaSrsInfo';`
    - After the inflections section, add: `{lemma.source === 'USER_ENTERED' && <LemmaSrsInfo lemmaId={lemma.id} />}`

    **Update App.tsx** — import ProgressDashboard and render below StudyLauncher:
    - Add: `import { ProgressDashboard } from '@/features/study/components/ProgressDashboard';`
    - In study idle phase: render `<StudyLauncher />` then `<ProgressDashboard />`
  </action>
  <verify>
    cd /Users/kevin/bulgarian-vocabulary/frontend && npx tsc --noEmit 2>&1 | tail -10
    npm run build 2>&1 | tail -5
    curl -s http://localhost:8080/api/study/progress
  </verify>
  <done>ProgressDashboard, LemmaSrsInfo, useProgress, useLemmaStats created. VocabularyDetail and App updated. TypeScript and build pass.</done>
</task>

</tasks>

<verification>
1. mvn compile passes
2. npx tsc --noEmit passes
3. npm run build succeeds
4. GET /api/study/progress returns correct counts
5. Study tab idle phase shows ProgressDashboard below StudyLauncher
6. VocabularyDetail for USER_ENTERED lemma shows LemmaSrsInfo
7. Studied lemma shows review count, retention, next review date
</verification>

<output>
After completion, create `.planning/phases/06-flashcards-basic-study/06-03-SUMMARY.md`
</output>
