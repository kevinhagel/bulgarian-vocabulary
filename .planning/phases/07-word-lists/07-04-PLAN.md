---
phase: 07-word-lists
plan: 04
type: execute
wave: 4
depends_on: [07-03]
files_modified:
  - frontend/src/features/vocabulary/components/VocabularyList.tsx
  - frontend/src/features/vocabulary/components/VocabularyCard.tsx
autonomous: true

must_haves:
  truths:
    - "List count badge on vocabulary cards shows how many lists contain that lemma (Phase 8 enhancement — deferred)"
    - "All 6 Phase 7 success criteria pass end-to-end UAT"
    - "Batch add handles empty input, single word, and 10+ words"
    - "Study Due on a list with no due cards shows a clear error message (not a crash)"
    - "Practice All on an empty list shows a clear error message (not a crash)"
    - "Removing the last lemma from a list leaves the list intact (not deleted)"
    - "Deleting a vocabulary entry also removes it from all lists (cascade in DB)"
    - "iPhone UAT: all tap targets reachable, textarea accepts Cyrillic input, modals scrollable"
    - "npx tsc --noEmit passes"
    - "npm run build succeeds"
  artifacts:
    - path: ".planning/phases/07-word-lists/07-04-SUMMARY.md"
      provides: "Phase 7 complete summary"
      contains: "Phase 7 complete"
---

<objective>
Harden Phase 7 with edge case handling, error messages, and full end-to-end UAT across all 6 success criteria. Includes iPhone-specific review of tap targets and Cyrillic keyboard compatibility.

This plan has no new features — it validates and polishes what Plans 01-03 built.
</objective>

<tasks>

<task type="auto">
  <name>Task 1: Error message hardening in AddVocabularyToList and study launch</name>
  <files>
    frontend/src/features/lists/components/AddVocabularyToList.tsx
    frontend/src/App.tsx
  </files>
  <action>
    **AddVocabularyToList edge cases to verify and fix if needed:**

    1. **Empty input guard**: "Add All" button disabled when `parseWords(input).length === 0` — already in design, verify it.
    2. **Single word**: works identically to multi-word.
    3. **All words already exist**: all show `duplicate_found` status, all added to list. Not an error.
    4. **Network failure mid-batch**: one word fails (status: 'failed'), rest continue. Check that a throw inside the loop `continue`s rather than breaking the whole batch.
    5. **Search returns empty on 409**: status shows `failed` with message "Word not found after duplicate error" — already handled.

    Review the `processWords` loop in `AddVocabularyToList.tsx`. Ensure the `catch` block handles ALL error cases and never lets the loop crash silently. If any issues found, fix them.

    **Study launch error handling in App.tsx** — replace `alert()` with an inline error state:

    Add state: `const [listStudyError, setListStudyError] = useState<string | null>(null);`

    In `handleListStudy`:
    ```tsx
    const handleListStudy = async (listId: number, mode: 'DUE' | 'ALL') => {
      setListStudyError(null);
      try {
        const result = await startListSession.mutateAsync({ listId, mode });
        studyStore.startSession(result.sessionId, result.cardCount, result.firstCard);
        setAppView('study');
      } catch (err: any) {
        const msg = err?.response?.data?.detail
          ?? (mode === 'DUE' ? 'No due or new cards in this list. Try Practice All.' : 'List is empty — add vocabulary first.');
        setListStudyError(msg);
      }
    };
    ```

    Pass `studyError` and `onClearError` to `ListDetail` and display it as a banner above the action buttons:
    ```tsx
    {studyError && (
      <div className="bg-orange-50 border border-orange-200 rounded-xl p-3 text-sm text-orange-700 mb-3">
        {studyError}
      </div>
    )}
    ```

    Update `ListDetail` props to accept `studyError?: string | null`.
    Clear the error when the user navigates back or opens Add Vocabulary.
  </action>
  <verify>
    cd /Users/kevin/bulgarian-vocabulary/frontend && npx tsc --noEmit 2>&1 | tail -10
    npm run build 2>&1 | tail -5
  </verify>
  <done>Error handling hardened. No alert() calls. TypeScript and build pass.</done>
</task>

<task type="auto">
  <name>Task 2: Full end-to-end UAT — all 6 Phase 7 success criteria</name>
  <files>
    (no file changes — verification only)
  </files>
  <action>
    With backend and frontend both running, verify each success criterion:

    **SC1: User can create named word list**
    - Navigate to Lists tab
    - Tap "+ New List"
    - Enter "Elena Lesson UAT" → Create
    - List card appears with "0 words"

    **SC2: User can add lemmas to word list**
    - Open the list → tap "Add Vocabulary"
    - Enter:
      ```
      чете
      казвам
      казвам се
      ```
    - Tap "Add All"
    - Verify: чете → "Added as чета", казвам → "Added as казвам", казвам се → "Added as казвам се"
    - Tap Done → list shows 3 members

    **SC2b: Adding already-existing vocabulary**
    - Tap Add Vocabulary again, enter "казвам"
    - Verify: status shows "Already exists as казвам — added to list" (409 handled)

    **SC3: User can remove lemmas from word list**
    - In list detail, tap ✕ next to one lemma
    - Lemma removed from list, count decreases
    - List is NOT deleted (still shows remaining lemmas)

    **SC4: User can delete word list**
    - Tap Delete → confirm
    - Returns to Lists overview, list is gone
    - Vocabulary entries still exist in Vocabulary tab

    **SC5: User can view all word lists**
    - Create two more lists with different names
    - Lists tab shows all lists alphabetically with correct word counts

    **SC6a: Study Due mode**
    - Create fresh list with 2-3 words that have no SRS state (new)
    - Tap "Study Due" → session starts with those cards → switches to Study tab
    - FlashcardView shows Bulgarian word, reveal, correct/incorrect works
    - Session summary shown at end

    **SC6b: Practice All mode**
    - On same list, tap "Practice All" → all list members appear (regardless of SRS schedule)
    - FlashcardView and rating work identically

    **Error cases:**
    - "Study Due" on list with no due/new cards → orange banner "No due or new cards..."
    - "Practice All" on empty list → orange banner "List is empty..."
    - Both errors dismissible (navigate away clears them)

    **iPhone UAT (test on actual device or browser mobile emulation):**
    - All three tab buttons tappable
    - ListCard tap targets large enough
    - Textarea in Add Vocabulary accepts Cyrillic keyboard input
    - Modals scrollable when content is long
    - Remove (✕) button on list members tappable without accidental audio play
    - Study session buttons (Study Due, Practice All) prominent and tappable
  </action>
  <verify>
    All 6 success criteria pass.
    iPhone/mobile emulation: all interactions work.
    npx tsc --noEmit passes.
    npm run build succeeds.
  </verify>
  <done>All 6 Phase 7 success criteria verified. Phase 7 complete.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. All 6 SC verified end-to-end
4. Error states shown inline (no alert() calls)
5. Empty list / no due cards handled gracefully
6. iPhone tap targets and Cyrillic input confirmed
7. Deleting vocab entry removes it from lists (DB cascade)
</verification>

<success_criteria>
Phase 7 fully complete. All 6 success criteria met. Production-quality error handling. Mobile-verified.
</success_criteria>

<output>
After completion:
1. Create `.planning/phases/07-word-lists/07-04-SUMMARY.md`
2. Update `.planning/STATE.md` — set current phase to 8, Phase 7 complete
3. Update `.planning/ROADMAP.md` — mark Phase 7 complete with today's date
</output>
