# Session Summary: 2026-02-24

## Session Info
- **Date:** 2026-02-24
- **Duration:** ~1 hour
- **Focus:** Telegram Bot — built from scratch and deployed as launchd service

---

## What We Worked On

Built and deployed a Telegram bot (`@HagelMacStudio_bot`) that serves as both a Bulgarian vocabulary learning companion and an infrastructure watchdog for the Mac Studio. The bot runs as a persistent launchd service outside Docker Compose, so it can monitor and restart everything else.

---

## Accomplishments

### ✅ Telegram bot built and running

Five-file Python service in `telegram-bot/`:

| File | Role |
|------|------|
| `bot.py` | Commands, background monitors, scheduler setup |
| `checks.py` | Shell-level health checks: Colima, Docker, Vault, nginx, disk, SSL, Ollama |
| `vocab.py` | HTTP client for Spring Boot admin/vocabulary/progress APIs |
| `scheduler.py` | Scheduled message jobs (morning word, SRS nudge, weekly summary, lesson brief) |
| `config.py` | `.env` loader |

### ✅ All vocabulary commands working

- `/word [text]` — free-text search; also works as plain text (no slash)
- `/stats` — lemma counts, SRS due/new cards, retention rate
- `/queue` — sentence generation progress bar
- `/lesson_today` — pre-lesson briefing on demand (not auto-scheduled, since lesson times vary)

### ✅ Full infrastructure monitoring

- `/status` — one-shot view of Colima, all containers, Vault, nginx, Ollama, disk, app stats
- `/containers` — Docker container list with health
- `/disk` — T7-NorthStar (Ollama), T9-NorthStar (DB), internal SSD
- `/ollama` — loaded model and processor (GPU/CPU)
- `/vault` — seal status
- `/logs [name]` — last 30 lines of any container
- `/restart colima|backend|postgres|valkey|all` — restart services; friendly name → real container name mapping

### ✅ Proactive background alerts (no prompting needed)

| Check | Frequency | Trigger |
|-------|-----------|---------|
| Colima health + auto-restart | every 5 min | VM down → restart + notify |
| Container health | every 5 min | unhealthy → notify |
| Vault seal | every 5 min | sealed → notify |
| Disk space | hourly | >80% warn, >90% critical |
| SSL cert expiry | 9am daily | <30 days warn, <7 days critical |

All alerts respect quiet hours (midnight–6am Sofia time).

### ✅ Scheduled learning messages

- **8:00am** — morning message with word of the day, SRS due count, new card count
- **6:00pm** — SRS nudge if ≥5 cards due
- **Sunday 8:00pm** — weekly summary (words, reviews, retention rate)

### ✅ launchd service installed

- Plist: `~/Library/LaunchAgents/com.bgvocab.telegram-bot.plist`
- `KeepAlive: true` — restarts automatically if it crashes
- Logs to: `telegram-bot/bot.log`
- Verified working across iPhone, MacBook, and Mac Studio simultaneously

---

## Issues Encountered

### ❌ Container name mismatch (Minor)
- **Symptom:** PostgreSQL showed no status in `/status`
- **Root Cause:** Code searched for fragment `"postgres"` but actual container is named `bulgarian-vocab-db`
- **Resolution:** Fixed fragment to `"db"`; added full name map for `/restart` command

### ❌ Startup crash on first run (Minor)
- **Symptom:** Bot crashed immediately on first start — "Chat not found"
- **Root Cause:** Proactive startup message sent before user had ever opened the bot chat
- **Resolution:** Wrapped `send_startup_message` in try/except with a warning log

### ❌ pip3 pointed to Python 3.9 (Minor)
- **Symptom:** `import telegram` failed even after `pip3 install`
- **Root Cause:** `/usr/bin/pip3` belongs to Python 3.9; homebrew Python 3.14 is at `/opt/homebrew/bin/python3`
- **Resolution:** Used `python3 -m pip install --break-system-packages` to install into the correct interpreter

---

## Key Decisions Made

| Decision | Rationale |
|----------|-----------|
| APScheduler instead of PTB JobQueue | APScheduler has cleaner cron syntax; PTB's built-in job queue had API compatibility issues with v22 |
| Quiet hours midnight–6am | No point waking Kevin with infrastructure alerts at 2am |
| `/lesson_today` on demand, not auto-scheduled | Elena lessons are irregular (Tue/Fri ~12:00 but not guaranteed) |
| Container name map in `/restart` | Users type `postgres`, real name is `bulgarian-vocab-db` — both should work |
| Bot runs outside Docker Compose | Must be able to restart Docker from outside; can't be inside what it monitors |

---

## Technical Notes

**Reload the bot after code changes:**
```bash
launchctl unload ~/Library/LaunchAgents/com.bgvocab.telegram-bot.plist
launchctl load  ~/Library/LaunchAgents/com.bgvocab.telegram-bot.plist
```

**Watch live logs:**
```bash
tail -f ~/bulgarian-vocabulary/telegram-bot/bot.log
```

**Check it's running:**
```bash
launchctl list | grep telegram
# Should show a PID in column 1 (non-zero = running)
```

**Python version:** `/opt/homebrew/bin/python3` (3.14.3) — not the system Python 3.9

**Dependencies installed with:**
```bash
python3 -m pip install --break-system-packages "python-telegram-bot[job-queue]" httpx psycopg2-binary redis python-dotenv APScheduler
```

---

*Session Date: 2026-02-24*
*Written by: Claude Code (claude-sonnet-4-6)*
